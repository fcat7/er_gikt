name: CommitLint (pre-commit + commitizen)
on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  pre-commit-commitlint:
    runs-on: ubuntu-latest
    steps:
      # 1. æ‹‰å–å®Œæ•´ä»“åº“å†å²ï¼ˆä¿ç•™åŸæœ‰é€»è¾‘ï¼‰
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. é…ç½® Python ç¯å¢ƒï¼ˆä¸æœ¬åœ° kt ç¯å¢ƒç‰ˆæœ¬ä¸€è‡´ï¼‰
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: 'pip'

      # 3. å®‰è£…ä¾èµ–ï¼ˆpre-commit + commitizenï¼Œé€‚é…ä½ çš„é…ç½®ï¼‰
      - name: Install dependencies
        run: |
          pip install pre-commit commitizen==3.27.0
          # éªŒè¯ä¾èµ–å®‰è£…
          pre-commit --version
          cz --version

      # 4. æ‰§è¡Œæäº¤ä¿¡æ¯æ ¡éªŒï¼ˆé€‚é… commitizen + è‡ªå®šä¹‰é’©å­ï¼‰
      - name: Run commit validation (commitizen + custom check)
        run: |
          # å®šä¹‰é€šç”¨æ ¡éªŒå‡½æ•°ï¼šæ ¡éªŒå•ä¸ªæäº¤çš„ä¿¡æ¯
          validate_single_commit() {
            local commit_hash=$1
            local commit_msg_file=$(mktemp)
            
            # å¯¼å‡ºæäº¤ä¿¡æ¯åˆ°ä¸´æ—¶æ–‡ä»¶ï¼ˆæ¨¡æ‹Ÿ commit-msg é˜¶æ®µçš„æ–‡ä»¶è¾“å…¥ï¼‰
            git log -1 --format=%B $commit_hash > $commit_msg_file
            
            echo "ğŸ” æ ¡éªŒæäº¤ $commit_hash çš„ä¿¡æ¯..."
            
            # ç¬¬ä¸€æ­¥ï¼šæ‰§è¡Œ commitizen æ ¡éªŒï¼ˆæ ¸å¿ƒè§„åˆ™ï¼Œå¯¹åº” pyproject.tomlï¼‰
            if ! pre-commit run commitizen --hook-stage commit-msg --commit-msg-filename $commit_msg_file; then
              echo "âŒ æäº¤ $commit_hash ä¸ç¬¦åˆ Conventional Commits è§„èŒƒï¼ˆcommitizen æ ¡éªŒå¤±è´¥ï¼‰"
              rm -f $commit_msg_file
              exit 1
            fi
            
            # ç¬¬äºŒæ­¥ï¼šæ‰§è¡Œæœ¬åœ°è‡ªå®šä¹‰é’©å­ï¼ˆcheck-breaking-expï¼Œå¯¹åº”ä½ çš„ local é’©å­ï¼‰
            if ! pre-commit run check-breaking-exp --hook-stage commit-msg --commit-msg-filename $commit_msg_file; then
              echo "âŒ æäº¤ $commit_hash ä¸ç¬¦åˆ BREAKING-EXP è§„åˆ™ï¼ˆè‡ªå®šä¹‰æ ¡éªŒå¤±è´¥ï¼‰"
              rm -f $commit_msg_file
              exit 1
            fi
            
            rm -f $commit_msg_file
            echo "âœ… æäº¤ $commit_hash æ ¡éªŒé€šè¿‡"
          }

          # å®šä¹‰æ‰¹é‡æ ¡éªŒå‡½æ•°ï¼šéå†æŒ‡å®šæäº¤èŒƒå›´
          validate_commits_range() {
            local from_commit=$1
            local to_commit=$2
            
            # éå†æäº¤èŒƒå›´çš„æ‰€æœ‰ commit hash
            git log --format=%H $from_commit..$to_commit | while read -r commit_hash; do
              validate_single_commit $commit_hash
              if [ $? -ne 0 ]; then
                exit 1
              fi
            done
          }

          # é€‚é… PR/push åœºæ™¯ï¼ˆä¸åŸæœ‰é€»è¾‘å®Œå…¨ä¸€è‡´ï¼‰
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # PR åœºæ™¯ï¼šæ ¡éªŒ origin/main åˆ° HEAD çš„æ‰€æœ‰æäº¤
            validate_commits_range origin/main HEAD
          else
            # Push åœºæ™¯ï¼šæ ¡éªŒæœ€è¿‘æäº¤ï¼ˆå…¼å®¹é¦–æ¬¡æäº¤ï¼‰
            COMMIT_RANGE="HEAD~1..HEAD"
            if ! git rev-parse --verify HEAD~1 >/dev/null 2>&1; then
              COMMIT_RANGE="HEAD"
            fi
            validate_commits_range ${COMMIT_RANGE%..*} ${COMMIT_RANGE#*..}
          fi

          echo "ğŸ‰ æ‰€æœ‰æäº¤ä¿¡æ¯å‡ç¬¦åˆè§„èŒƒï¼ˆcommitizen + è‡ªå®šä¹‰è§„åˆ™ï¼‰"